# Docker Image Setup

This guide provides comprehensive instructions for building, configuring, and deploying the BioCage Docker image. The Docker environment provides a secure, isolated execution environment for running Python code generated by LLMs.

## üìã Prerequisites

Before getting started, ensure you have the following installed on your system:

- **Docker**: Version 20.10 or higher
- **Docker Compose**: Version 2.0 or higher (optional, for advanced setups)
- **Git**: For cloning the repository
- **uv**: Python package manager (for dependency management)

### Installing uv (if not already installed)

```bash
# On macOS and Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# On Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

## üèóÔ∏è Building the Docker Image

### Step 1: Navigate to the Docker Directory

```bash
cd python_docker
```

The `python_docker/` directory contains all the necessary files for building the containerized environment:

- `Dockerfile`: Container definition and build instructions
- `pyproject.toml`: Python environment and dependency specifications
- `build.sh`: Automated build script with optimizations
- `demo.sh`: Testing script to verify container functionality
- `requirements.txt`: Generated dependency file (auto-generated)

### Step 2: Define Your Environment

The first step is to configure the Python environment by editing the `pyproject.toml` file in the `python_docker/` directory. This file describes the environment used by the sandbox.

Example `pyproject.toml` configuration:

```toml
[project]
name = "BioCage"
version = "0.1.0"
description = "Python sandbox for LLM-generated code execution"
dependencies = [
    "numpy>=1.24.0",
    "pandas>=2.0.0",
    "matplotlib>=3.7.0",
    "requests>=2.31.0",
    "scipy>=1.10.0",
]

[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"
```

### Step 3: Generate Requirements File

Once the `pyproject.toml` file is configured, generate the `requirements.txt` file:

```bash
uv pip compile pyproject.toml -o requirements.txt
```

This command:
- Resolves all dependency versions
- Creates a lock file for reproducible builds
- Ensures compatibility between packages
- Generates a pip-compatible requirements file

### Step 4: Build the Docker Image

Use the provided build script for an optimized build process:

```bash
./build.sh
```

The build script performs the following operations:

- **No-cache build**: Ensures fresh package installations
- **Pull latest base images**: Gets the most recent security updates
- **Multi-tag creation**: Tags with both `latest` and date-based tags
- **Size optimization**: Reports final image size
- **Build verification**: Confirms successful completion

#### Manual Build (Alternative)

If you prefer to build manually or need custom options:

```bash
docker build \
    --no-cache \
    --pull \
    --tag biocage:latest \
    --tag biocage:$(date +%Y%m%d) \
    .
```

### Build Output

After a successful build, you should see output similar to:

```
üêç Building BioCage Container...
‚úÖ Build complete!
üì¶ Image size:
REPOSITORY    TAG       SIZE
biocage       latest    450MB
```

## üß™ Testing the Container

### Automated Testing

Verify that the container is working correctly by running the comprehensive demo script:

```bash
./demo.sh
```

The demo script performs the following tests:

#### Test 1: Basic Python Execution
```bash
echo 'print("Hello from BioCage!")' | docker run --rm -i biocage:latest
```

#### Test 2: Dependencies Verification
Tests NumPy and Pandas functionality to ensure scientific computing libraries are properly installed.

#### Test 3: Environment Variable Execution
```bash
docker run --rm -e PYTHON_CODE="print('Environment variable test works!')" biocage:latest
```

#### Test 4: Error Handling
Verifies that errors are properly caught and returned in JSON format.

#### Test 5: Execution Timing
Tests performance and timeout handling.

### Manual Testing

You can also test individual components manually:

```bash
# Basic execution test
echo 'print("Hello World!")' | docker run --rm -i biocage:latest

# Test with dependencies
echo 'import numpy as np; print(np.array([1,2,3]))' | docker run --rm -i biocage:latest

# Test error handling
echo 'print(undefined_variable)' | docker run --rm -i biocage:latest
```

## üîß Configuration Options

### Environment Variables

The container supports several configuration options through environment variables:

| Variable | Description | Default | Example |
|----------|-------------|---------|---------|
| `PYTHON_CODE` | Code to execute when provided | None | `print("Hello World!")` |
| `EXECUTION_TIMEOUT` | Maximum execution time (seconds) | 30 | `60` |
| `MEMORY_LIMIT` | Memory limit for container | 512MB | `1GB` |

### Runtime Configuration

Configure resource limits when running the container:

```bash
# Set memory limit
docker run --rm -i --memory="512m" biocage:latest

# Set CPU limit
docker run --rm -i --cpus="1.0" biocage:latest

# Set execution timeout
docker run --rm -i -e EXECUTION_TIMEOUT=60 biocage:latest
```

## üì¶ Image Management

### Viewing Built Images

```bash
# List BioCage images
docker images biocage

# View image details
docker inspect biocage:latest
```

### Cleaning Up

```bash
# Remove old images
docker image prune

# Remove specific version
docker rmi biocage:20241201

# Remove all BioCage images
docker rmi $(docker images biocage -q)
```

## üöÄ Deployment Options

### Docker Compose (Recommended for Production)

Create a `docker-compose.yml` file:

```yaml
version: '3.8'
services:
  biocage:
    image: biocage:latest
    container_name: biocage
    restart: unless-stopped
    memory: 512m
    cpus: 1.0
    environment:
      - EXECUTION_TIMEOUT=30
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
```

Deploy with:
```bash
docker-compose up -d
```

### Kubernetes Deployment

Example Kubernetes deployment:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: biocage
spec:
  replicas: 3
  selector:
    matchLabels:
      app: biocage
  template:
    metadata:
      labels:
        app: biocage
    spec:
      containers:
      - name: biocage
        image: biocage:latest
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        env:
        - name: EXECUTION_TIMEOUT
          value: "30"
        securityContext:
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          allowPrivilegeEscalation: false
```

## üõ†Ô∏è Customization

### Adding Custom Dependencies

1. Edit `python_docker/pyproject.toml`:
```toml
dependencies = [
    "numpy>=1.24.0",
    "pandas>=2.0.0",
    "your-custom-package>=1.0.0",
]
```

2. Regenerate requirements:
```bash
uv pip compile pyproject.toml -o requirements.txt
```

3. Rebuild the image:
```bash
./build.sh
```

### Custom Base Image

Modify the Dockerfile to use a different base image:

```dockerfile
# Use a specific Python version
FROM python:3.11-slim

# Or use a different distribution
FROM python:3.11-alpine
```

### Security Hardening

For enhanced security, consider these additional measures:

```dockerfile
# Add security improvements to Dockerfile
USER nobody
WORKDIR /app
COPY --chown=nobody:nobody . .

# Disable network access
RUN echo 'net.ipv4.ip_forward=0' >> /etc/sysctl.conf
```

## üêõ Troubleshooting

### Common Issues

**Build fails with dependency conflicts:**
```bash
# Clear uv cache
uv cache clean

# Regenerate requirements with resolution strategy
uv pip compile pyproject.toml -o requirements.txt --resolution=highest
```

**Container runs but code execution fails:**
```bash
# Check container logs
docker logs <container_id>

# Run container in interactive mode for debugging
docker run --rm -it biocage:latest /bin/bash
```

**Image size too large:**
```bash
# Use multi-stage builds in Dockerfile
# Remove unnecessary packages
# Use alpine-based images
```

### Getting Help

If you encounter issues:

1. Check the [GitHub Issues](https://github.com/biocypher/biocage/issues)
2. Run the demo script to identify specific problems
3. Review Docker logs for detailed error messages
4. Ensure all prerequisites are correctly installed

## üìà Performance Optimization

### Build Performance

- Use Docker BuildKit for faster builds:
  ```bash
  DOCKER_BUILDKIT=1 docker build .
  ```

- Leverage build cache by ordering Dockerfile commands appropriately
- Use `.dockerignore` to exclude unnecessary files

### Runtime Performance

- Pre-warm containers in production environments
- Use appropriate resource limits based on workload
- Monitor container metrics and adjust as needed

---

*The Docker environment provides a secure, isolated, and performant execution environment for BioCage. For additional support, please refer to the project documentation or open an issue on GitHub.* 